{% extends "base.html" %}
{% block content %}
<div class="flex items-center justify-between mb-6">
    <a href="/?week={{ week }}" class="text-gray-600 hover:text-gray-900 bg-white px-4 py-2 rounded-lg shadow-sm border">&larr; Dashboard</a>
    <div class="text-center">
        <h2 class="text-2xl font-bold text-gray-800">{{ week_display }}</h2>
        <p class="text-sm text-gray-500">{{ week }}</p>
    </div>
    <div></div>
</div>

<!-- Tabs -->
<div class="flex gap-2 mb-6">
    <a href="/week/{{ week }}/events?filter=sales" 
       class="px-4 py-2 rounded-lg text-sm font-medium transition
              {% if filter == 'sales' %}bg-krs-600 text-white{% else %}bg-white text-gray-600 border hover:bg-gray-50{% endif %}">
        Sales ({{ sales_count }})
    </a>
    <a href="/week/{{ week }}/events?filter=other"
       class="px-4 py-2 rounded-lg text-sm font-medium transition
              {% if filter == 'other' %}bg-gray-700 text-white{% else %}bg-white text-gray-600 border hover:bg-gray-50{% endif %}">
        Other ({{ other_count }})
    </a>
    <a href="/week/{{ week }}/events?filter=all"
       class="px-4 py-2 rounded-lg text-sm font-medium transition
              {% if filter == 'all' %}bg-blue-600 text-white{% else %}bg-white text-gray-600 border hover:bg-gray-50{% endif %}">
        All ({{ sales_count + other_count }})
    </a>
</div>

{% if events %}
<div class="bg-white rounded-xl shadow-sm border overflow-hidden">
    <table class="w-full text-sm" id="events-table">
        <thead class="bg-gray-50 border-b">
            <tr>
                <th class="text-left px-4 py-3 font-medium text-gray-500 cursor-pointer hover:text-gray-800 select-none" onclick="sortTable(0)">
                    Agent <span class="sort-arrow" data-col="0"></span>
                </th>
                <th class="text-left px-4 py-3 font-medium text-gray-500 cursor-pointer hover:text-gray-800 select-none" onclick="sortTable(1)">
                    Event <span class="sort-arrow" data-col="1"></span>
                </th>
                <th class="text-left px-4 py-3 font-medium text-gray-500 cursor-pointer hover:text-gray-800 select-none" onclick="sortTable(2)">
                    Date/Time <span class="sort-arrow" data-col="2"></span>
                </th>
                <th class="text-left px-4 py-3 font-medium text-gray-500">AI Reasoning</th>
                <th class="text-center px-4 py-3 font-medium text-gray-500 cursor-pointer hover:text-gray-800 select-none" onclick="sortTable(4)">
                    Type <span class="sort-arrow" data-col="4"></span>
                </th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
            {% for e in events %}
            {% set effective = e.override or e.classification %}
            <tr class="hover:bg-gray-50" id="row-{{ e.id }}">
                <td class="px-4 py-3 font-medium text-gray-800 whitespace-nowrap" data-sort="{{ e.agent_name }}">{{ e.agent_name }}</td>
                <td class="px-4 py-3" data-sort="{{ (e.title or '')|lower }}">
                    <div class="font-medium text-gray-800">{{ e.title or '(no title)' }}</div>
                    {% if e.description %}
                    <div class="text-xs text-gray-400 mt-1 truncate max-w-xs">{{ e.description[:100] }}</div>
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-gray-500 whitespace-nowrap text-xs" data-sort="{{ e.start_time or '' }}">
                    {{ e.start_time[:16] if e.start_time else '' }}
                </td>
                <td class="px-4 py-3 text-xs text-gray-400 max-w-xs truncate">
                    {{ e.ai_reasoning or '' }}
                    {% if e.override %}
                    <span class="text-orange-500 font-medium">(overridden)</span>
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-center" data-sort="{{ effective }}">
                    {% if effective == 'sales' %}
                    <button onclick="reclassify('{{ e.id }}', 'not_sales')"
                            class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-medium hover:bg-red-100 hover:text-red-700 transition"
                            title="Click to change to Not Sales">
                        &#10003; Sales
                    </button>
                    {% else %}
                    <button onclick="reclassify('{{ e.id }}', 'sales')"
                            class="bg-gray-100 text-gray-500 px-3 py-1 rounded-full text-xs font-medium hover:bg-green-100 hover:text-green-700 transition"
                            title="Click to change to Sales">
                        Other
                    </button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="text-center py-16 text-gray-400">
    <p class="text-lg">No {{ filter }} events this week.</p>
</div>
{% endif %}

<script>
let currentSort = {col: -1, asc: true};

function sortTable(colIdx) {
    const table = document.getElementById('events-table');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    // Toggle direction
    if (currentSort.col === colIdx) {
        currentSort.asc = !currentSort.asc;
    } else {
        currentSort.col = colIdx;
        currentSort.asc = true;
    }

    rows.sort((a, b) => {
        const aVal = a.cells[colIdx].getAttribute('data-sort') || a.cells[colIdx].textContent.trim();
        const bVal = b.cells[colIdx].getAttribute('data-sort') || b.cells[colIdx].textContent.trim();
        const cmp = aVal.localeCompare(bVal, undefined, {sensitivity: 'base'});
        return currentSort.asc ? cmp : -cmp;
    });

    rows.forEach(row => tbody.appendChild(row));

    // Update arrows
    document.querySelectorAll('.sort-arrow').forEach(el => el.textContent = '');
    const arrow = document.querySelector(`.sort-arrow[data-col="${colIdx}"]`);
    if (arrow) arrow.textContent = currentSort.asc ? ' \u25B2' : ' \u25BC';
}

async function reclassify(eventId, newClass) {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '...';
    await fetch('/api/override', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({event_id: eventId, classification: newClass})
    });
    // Update row in-place instead of reloading (preserves sort)
    const row = document.getElementById('row-' + eventId);
    if (!row) { location.reload(); return; }
    const typeCell = row.cells[4];
    const reasonCell = row.cells[3];
    typeCell.setAttribute('data-sort', newClass);
    if (newClass === 'sales') {
        typeCell.innerHTML = `<button onclick="reclassify('${eventId}', 'not_sales')"
            class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-medium hover:bg-red-100 hover:text-red-700 transition"
            title="Click to change to Not Sales">&#10003; Sales</button>`;
    } else {
        typeCell.innerHTML = `<button onclick="reclassify('${eventId}', 'sales')"
            class="bg-gray-100 text-gray-500 px-3 py-1 rounded-full text-xs font-medium hover:bg-green-100 hover:text-green-700 transition"
            title="Click to change to Sales">Other</button>`;
    }
    // Add override indicator
    if (!reasonCell.innerHTML.includes('(overridden)')) {
        reasonCell.innerHTML += ' <span class="text-orange-500 font-medium">(overridden)</span>';
    }
}
</script>
{% endblock %}
